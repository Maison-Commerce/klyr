

{% liquid
  if section.settings.desktop_media_position == 'left'
    assign render_order = 'media,product-details'
  else
    assign render_order = 'product-details,media'
  endif

  assign product_has_media = true
  if closest.product.media.size == 0
    assign product_has_media = false
  endif

  assign product_grid_class = 'product-information__grid'

  if product_has_media == false
    assign product_grid_class = product_grid_class | append: ' product-information--media-none'
  elsif section.settings.desktop_media_position == 'right'
    assign product_grid_class = product_grid_class | append: ' product-information--media-right'
  else
    assign product_grid_class = product_grid_class | append: ' product-information--media-left'
  endif

  if section.settings.equal_columns
    assign product_grid_class = product_grid_class | append: ' product-information__grid--half'

    if section.settings.limit_details_width
      assign product_grid_class = product_grid_class | append: ' product-information__grid--limit-details'
    endif
  endif

  case section.settings.content_width
    when 'content-center-aligned'
      assign content_width = 'page-width'
    when 'content-full-width'
      assign content_width = 'full-width'
  endcase
%}

<script type="application/ld+json">
  {{ closest.product | structured_data }}
</script>
<script
  src="{{ 'custom-add-to-cart.js'| asset_url }}"
  defer="defer"
></script>

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  class="new-product__information product-information section--{{ content_width }} spacing-style color-{{ section.settings.color_scheme }} relative"
  style="{% render 'spacing-style', settings: section.settings %} --gap: {{ section.settings.gap }}px;"
>
  {% if section.settings.desktop_media_position == 'left' and product_has_media %}
    {% assign product_href = '#ProductInformation-' | append: section.id %}
    {% render 'skip-to-content-link', href: product_href, text: 'accessibility.skip_to_product_info' %}
  {% endif %}
  <div
    class="{{ product_grid_class }} new-product__information-grid"
    data-product-grid-content
  >
    {% assign render_order_array = render_order | split: ',' %}
    {% capture media %}
      <div
        class="product-information__media new-product__information-media"
        data-testid="product-information-media"
      >
        {%- content_for 'block',
          type: 'new-product-media-gallery',
          id: 'media-gallery',
          closest.product: closest.product
        -%}
      </div>
    {% endcapture %}

    {% capture details %}
      {% content_for 'block',
        type: '_product-details',
        id: 'product-details',
        closest.product: closest.product
      %}
    {% endcapture %}

    {% for block in render_order_array %}
      {% if block == 'media' and product_has_media %}
        {{ media }}
      {% elsif block == 'product-details' %}
        {{ details }}
      {% endif %}
    {% endfor %}
  </div>

  {% if section.settings.enable_sticky_atc %}
    {% assign sticky_product = closest.product %}
    <style>
      .product__sticky-atc {
        position: fixed;
        bottom: 0;
        width: 100%;
        background:rgb(255, 255, 255);
        box-shadow: 2px -2px 4px 0px rgba(0, 0, 0, .1);
        z-index: -1;
        opacity: 0;
        visibility: hidden;
        transition: 0.3s;
      }
      .product__sticky-atc.visible {
        z-index: 10;
        opacity: 1;
        visibility: visible;
      }
      .product__sticky-atc-wrapper {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 12px 16px;
      }
      .product__sticky-atc-info {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .product__sticky-atc-image {
        width: 65px;
        height: 65px;
        display: block;
        object-fit: cover;
      }
      .product__sticky-atc-details {
        display: flex;
        align-items: flex-start;
        flex-direction: column;
        gap: 8px;
      }
      .product__sticky-atc-heading {
        margin: 0;
            margin-bottom: -3px;
        color: #231C19;
      }
      .product__sticky-atc-prices {
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: var(--swiss721BTMedium);
      }
      .product__sticky-atc-prices span {
        font-family: var(--swiss721BTMedium);
            color: #231C19;
      }
      .product__sticky-atc-prices .regular-price {
        text-decoration: line-through;
        color: #231C19;
      }
      .product__sticky-atc-prices .product-price {
        color: #BD3C50;
      }
      .product__sticky-atc-info .product-badge-active {
        display: inline-flex;
        font-size: 10px;
        padding: 4px;
        line-height: 8px;
        color: #ffffff;
      }
      .product-badge-active.bg-red-dark:empty {
        display: none;
      }
      .quick-add__submit {
        font-family: var(--swiss721BTMedium);
        font-size: 12px;
        font-weight: 500;
        color: #ffffff;
        background-color: #231C19;
        text-transform: uppercase;
        border: 1px solid;
        padding: 10px 16px;
      }
      .quick-add__submit .loading-overlay__spinner {
        width: 1.1rem;
      }
      .quick-add__submit .loading-overlay__spinner .path {
        stroke: #ffffff;
      }
      @media screen and (min-width: 1024px) {
        .product__sticky-atc {
          display: none;
        }
        .quick-add__submit {
          padding: 10px 24px;
        }
      }
    </style>

    <div class="product__sticky-atc" data-sticky-atc-wrapper>
      <div class="product__sticky-atc-wrapper">
        <div class="product__sticky-atc-info">
          {% if sticky_product.metafields.custom.preview_image %}
            <img 
              src="{{ sticky_product.metafields.custom.preview_image | image_url: width: 120 }}" 
              width="auto" 
              height="auto" 
              alt="{{ sticky_product.title }}"
              class="product__sticky-atc-image"
            >
          {% else %}
            <img 
              src="{{ sticky_product.featured_image | image_url: width: 120 }}" 
              width="auto" 
              height="auto" 
              alt="{{ sticky_product.title }}"
              class="product__sticky-atc-image"
            >
          {% endif %}
          <div class="product__sticky-atc-details">
            <h3 class="product__sticky-atc-heading font-small">
              {{ sticky_product.title }}
            </h3>
            <div class="product__sticky-atc-prices font-small">
              <span class="regular-price price">{{ sticky_product.price | times: section.settings.first_bundle_quantity | money_without_trailing_zeros }} {{ cart.currency.iso_code }}</span>
              <span class="product-price">{{ sticky_product.price | money_without_trailing_zeros }} {{ cart.currency.iso_code }}</span>
            </div>
            <span class="product-badge-active bg-red-dark"></span>
          </div>
        </div>

        <button 
          type="submit" 
          class="quick-add__submit has__spinner"
          {% unless sticky_product.available %}
            disabled
          {% endunless %}
          data-sticky-atc
        >
          <div class="loading-overlay loader-hidden">
            <div class="loading-overlay__spinner">
              <svg
                aria-hidden="true"
                focusable="false"
                class="spinner"
                viewBox="0 0 66 66"
                xmlns="http://www.w3.org/2000/svg"
              >
                <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
              </svg>
            </div>
          </div>
          <span class="atc-button-text font-base">
            Add to Cart
          </span>
        </button>
      </div>
    </div>

    <script>
      (function() {
        // Store the initial scroll position
        const initialScrollY = window.scrollY || window.pageYOffset;
        
        document.addEventListener('DOMContentLoaded', function() {
          // Restore scroll position if it changed
          if (window.scrollY !== initialScrollY) {
            window.scrollTo(0, initialScrollY);
          }

          setTimeout(() => {
            const stickyAtcBar = document.querySelector('[data-sticky-atc-wrapper]');
            const stickyAtcBtn = document.querySelector('[data-sticky-atc]');
            const mainAtcButton = document.querySelector('[data-atc-button]');
            
            // Exit early if elements don't exist
            if (!mainAtcButton || !stickyAtcBar || !stickyAtcBtn) {
              return;
            }
    
            let isInitialized = false;

            function toggleStickyAtc() {
              if (!mainAtcButton) return;
              
              // Use a less intrusive method that doesn't force reflow
              const rect = mainAtcButton.getBoundingClientRect();
              const bottomPos = rect.top;
              
              if (bottomPos < 0) {
                stickyAtcBar.classList.add('visible');
              } else {
                stickyAtcBar.classList.remove('visible');
              }
            }

            function toggleVariant() {
              const qtyChoiceInputs = document.querySelectorAll('#product-quantity-choice input');

              qtyChoiceInputs.forEach(input => {
                input.addEventListener('change', () => {
                  let label = input.closest('label');
                  if (label) {
                    const selectedQty = label.querySelector('.product-badge-active');
                    const priceElement = label.querySelector('.sbc_bottom');

                    const stickyPrices = stickyAtcBar.querySelector('.product__sticky-atc-prices');
                    const stickyBadge = stickyAtcBar.querySelector('.product-badge-active');

                    if(priceElement && stickyPrices) 
                      stickyPrices.innerHTML = priceElement.innerHTML;
                    if(stickyBadge && selectedQty)
                      stickyBadge.innerHTML = selectedQty.innerHTML;
                    else
                      stickyBadge.innerHTML = '';
                  }
                });
              });
            }

            function initVariants() {
              const qtyInput = document.querySelector('#product-quantity-choice input:checked');
              if (qtyInput) {
                let label = qtyInput.closest('label');
                if (label) {
                  const selectedQty = label.querySelector('.product-badge-active');
                  const priceElement = label.querySelector('.sbc_bottom');

                  const stickyPrices = stickyAtcBar.querySelector('.product__sticky-atc-prices');
                  const stickyBadge = stickyAtcBar.querySelector('.product-badge-active');
                  
                  if(priceElement && stickyPrices) 
                    stickyPrices.innerHTML = priceElement.innerHTML;
                  if(stickyBadge && selectedQty)
                    stickyBadge.innerText = selectedQty.innerText;
                }
              }
            }

            function scrollToTop() {
              stickyAtcBar.addEventListener('click', function(event) {
                if(event.target !== stickyAtcBtn) {
                  mainAtcButton.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
              });
            }
    
            // Add scroll listener with passive flag for better performance
            window.addEventListener('scroll', toggleStickyAtc, { passive: true });
            
            // Only check position on first user scroll, not on page load
            window.addEventListener('scroll', function initCheck() {
              if (!isInitialized) {
                isInitialized = true;
                toggleStickyAtc();
              }
            }, { once: true, passive: true });
            
            toggleVariant();
            initVariants();
            scrollToTop();
    
            stickyAtcBtn.addEventListener('click', function() {
              stickyAtcBtn.querySelector('.loading-overlay').classList.remove('loader-hidden');
              mainAtcButton.click();
              setTimeout(() => {
                stickyAtcBtn.querySelector('.loading-overlay').classList.add('loader-hidden');
              }, 1500);
            });

          }, 1000);
        });
      })();
    </script>
  {% endif %}
  
  {% content_for 'blocks' %}
</div>


{% unless closest.product.has_only_default_variant %}
  <div class="custom-modal-overlay" id="customModalOverlay">
    <div class="custom-modal" role="dialog" aria-modal="true">
      <div class="custom-modal-header">
        <h2 class="custom-modal-title">{{ section.settings.shade_text }}</h2>
        <button class="custom-close-btn" aria-label="Close modal">&times;</button>
      </div>
      <div class="custom-modal-body">
        <p>{{ section.settings.shade_title }}</p>
        {{ section.settings.shade_content }}
      </div>
    </div>
  </div>
{% endunless %}


{% stylesheet %}
  .product-information {
    gap: var(--gap) 0;
  }

  /* Base grid layout */
  .product-information__grid {
    display: grid;
    grid-template-columns: subgrid;
    grid-column: 1 / -1;
  }

  /* Default column positions */
  .product-details {
    order: 1;
  }

  .product-information__media {
    order: 0;
    width: 0;
    min-width: 100%;
  }

  /* Mobile styles */
  @media screen and (max-width: 749px) {
    .product-information__media {
      grid-column: 1 / -1;
    }

    .product-details {
      grid-column: 2 / 3;
    }
  }

  /* Desktop styles */
  @media screen and (min-width: 750px) {
    .product-information__grid {
      grid-column: 2;
    }

    /* Position when there is no media */
    .product-information__grid.product-information--media-none,
    .product-information__grid:has(.product-information__media:empty) {
      .product-details {
        width: var(--narrow-content-width);
        margin: 0 auto;
      }
    }

    /* Position when there is media */
    .product-information__grid:not(:has(.product-information__media:empty)) {
      /* Media on the left side */
      &.product-information--media-left {
        grid-template-columns: 1fr min(50vw, var(--sidebar-width));

        .product-information__media {
          padding-right: calc(var(--gap, 0) / 2);
        }

        .product-details {
          padding-left: calc(var(--gap, 0) / 2);
        }

        &:has(.media-gallery--extend) {
          grid-column: 1 / 3;
        }
      }

      /* Media on the right side */
      &.product-information--media-right {
        grid-template-columns: min(50vw, var(--sidebar-width)) 1fr;

        .product-information__media {
          padding-left: calc(var(--gap, 0) / 2);
          order: 1;
        }

        .product-details {
          padding-right: calc(var(--gap, 0) / 2);
          order: 0;
        }

        &:has(.media-gallery--extend) {
          grid-column: 2 / -1;
        }
      }

      /* Equal width columns */
      &.product-information__grid--half,
      &.product-information__grid--half:has(.media-gallery--extend) {
        grid-column: 1 / -1;
        grid-template-columns:
          var(--full-page-grid-margin) calc(var(--full-page-grid-central-column-width) / 2) calc(
            var(--full-page-grid-central-column-width) / 2
          )
          var(--full-page-grid-margin);

        &.product-information--media-left {
          .product-information__media {
            grid-column: 2 / 3;

            &:has(.media-gallery--extend) {
              grid-column: 1 / 3;
            }
          }

          .product-details {
            grid-column: 3 / 4;
          }
        }

        &.product-information--media-right {
          .product-information__media {
            grid-column: 3 / 4;

            &:has(.media-gallery--extend) {
              grid-column: 3 / -1;
            }
          }

          .product-details {
            grid-column: 2 / 3;
          }
        }
      }
    }

    /* Handle full width section */
    .section--full-width {
      .product-information__grid:not(:has(.product-information__media:empty)),
      .product-information__grid:not(:has(.product-information__media:empty)) {
        &.product-information--media-left,
        &.product-information--media-right {
          grid-column: 1 / -1;
        }

        &.product-information--media-left .product-details {
          padding-inline-end: var(--padding-lg);
        }

        &.product-information--media-right .product-details {
          padding-inline-start: var(--padding-lg);
        }

        &.product-information__grid--half.product-information--media-left {
          .product-information__media {
            grid-column: 1 / 3;
          }

          .product-details {
            grid-column: 3 / -1;
          }
        }

        &.product-information__grid--half.product-information--media-right {
          .product-information__media {
            grid-column: 3 / -1;
          }

          .product-details {
            grid-column: 1 / 3;
          }
        }
      }
    }
  }

  /* Wider sidebar for large screens */
  @media screen and (min-width: 1200px) {
    .product-information__grid:not(
        .product-information__grid--half,
        :has(.product-information__media:empty)
      ).product-information--media-left {
      grid-template-columns: 2fr 1fr;
    }

    .product-information__grid:not(
        .product-information__grid--half,
        :has(.product-information__media:empty)
      ).product-information--media-right {
      grid-template-columns: 1fr 2fr;
    }
  }

  .product-information__grid--limit-details .product-details > .group-block {
    max-width: var(--sidebar-width);
  }

  /* If the header is sticky, make product details content stick underneath the header */
  body:has(#header-group #header-component[data-sticky-state='active']) .product-details.sticky-content--desktop {
    --sticky-header-offset: var(--header-height);
  }
{% endstylesheet %}

{% schema %}
{
  "name": "New Product Info",
  "blocks": [
    {
      "type": "@app"
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "header",
      "content": "t:content.layout"
    },
    {
      "type": "select",
      "id": "content_width",
      "label": "t:settings.width",
      "options": [
        {
          "value": "content-center-aligned",
          "label": "t:options.page"
        },
        {
          "value": "content-full-width",
          "label": "t:options.full"
        }
      ],
      "default": "content-center-aligned"
    },
    {
      "type": "select",
      "id": "desktop_media_position",
      "label": "t:settings.media_position",
      "options": [
        {
          "value": "left",
          "label": "t:options.left"
        },
        {
          "value": "right",
          "label": "t:options.right"
        }
      ],
      "default": "left"
    },
    {
      "type": "checkbox",
      "id": "equal_columns",
      "label": "t:settings.equal_columns",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "limit_details_width",
      "label": "t:settings.limit_product_details_width",
      "default": false,
      "visible_if": "{{ section.settings.equal_columns }}"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky_atc",
      "label": "Enable Sticky Add to Cart",
      "default": false
    },
    {
      "type": "text",
      "id": "sticky_atc_text",
      "label": "Sticky Add to Cart Button Text",
      "default": "Add to Cart",
      "visible_if": "{{ section.settings.enable_sticky_atc }}"
    },
    {
      "type": "number",
      "id": "first_bundle_quantity",
      "label": "Discount first bundle quantity",
      "default": 1,
      "visible_if": "{{ section.settings.enable_sticky_atc }}"
    },
    {
      "type": "header",
      "content": "Find your Shade"
    },
    {
      "type": "text",
      "id": "shade_text",
      "label": "Shade Text",
      "default": "Find your Shade"
    },
    {
      "type": "inline_richtext",
      "id": "shade_title",
      "label": "Shade Title",
      "default": "This is the first paragraph of modal body content. You can add any text here."
    },
    {
      "type": "liquid",
      "id": "shade_content",
      "label": "Shade Content",
      "default": "<p>This is the second paragraph of modal body content. You can add any HTML here. Lorem ipsum dolor sit amet, consectetur adipisicing elit. Exercitationem deserunt aspernatur soluta alias ut quia incidunt maiores repellendus facilis. Fugit eius hic error velit quod alias incidunt beatae omnis quibusdam.Lorem ipsum dolor sit amet, consectetur adipisicing elit. Exercitationem deserunt aspernatur soluta alias ut quia incidunt maiores repellendus facilis. Fugit eius hic error velit quod alias incidunt beatae omnis quibusdam.Lorem ipsum dolor sit amet, consectetur adipisicing elit. Exercitationem deserunt aspernatur soluta alias ut quia incidunt maiores repellendus facilis. Fugit eius hic error velit quod alias incidunt beatae omnis quibusdam.</p>"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "t:settings.gap",
      "min": 0,
      "max": 48,
      "step": 4,
      "unit": "px",
      "default": 16
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:settings.color_scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "t:content.padding"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "t:settings.top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "t:settings.bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    }
  ],
  "presets": []
}
{% endschema %}
